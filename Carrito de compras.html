<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script defer src="carrito.js"></script>
    <title>Carrito de Compras</title>
</head>
<body>
    <nav>
        <div class="nav-bar">
            <i class='bx bx-menu sidebarOpen'></i>
            <span class="logo navLogo"><a href="INICIO.html"><img src="images/LOGO STRAW2.png" alt="LOGO EN FORMA DE FRESA" class="logo-image"></a></span>
            <div class="menu">
                <div class="logo-toggle">
                    <span class="logo"><a href="INICIO.html">STRAWBERRY</a></span>
                    <i class='bx bx-x siderbarClose'></i>
                </div>
                <ul class="nav-links">
                    <li><a href="INICIO.html">Inicio</a></li>
                    <li><a href="INICIO.html">Catálogo</a></li>
                    <li><a href="#">Marcas</a></li>
                </ul>
            </div>
            
            <div class="header-container">
                <div class="cart-user-container">
                    <div class="darkLight-searchBox">
                        <div class="dark-light">
                            <i class='bx bx-moon moon'></i>
                            <i class='bx bx-sun sun'></i>
                        </div>
                        <div class="searchBox">
                            <div class="searchToggle">
                                <i class='bx bx-x cancel'></i>
                                <i class='bx bx-search search'></i>
                            </div>
                            <div class="search-field">
                                <input type="text" placeholder="Search...">
                                <i class='bx bx-search'></i>
                            </div>
                        </div>
                    </div>
                    <div class="user">
                        <a href="#"><i class='bx bx-user-circle'></i></a>
                    </div>

                    <div class="cart">
                        <a href="#"><i class='bx bx-cart'></i></a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="cart container">
        <h1>Carrito de Compras</h1>
        <div class="cart-items">
            <!-- Los productos se agregarán dinámicamente aquí -->
        </div>
        <div class="cart-total">
            <h3>Total: $<span id="total">0.00</span></h3>
            <button id="checkoutBtn">Comprar</button>
            <button id="downloadReceipt" style="display: none;">Descargar Recibo en PDF</button>
        </div>
    </section>

    <section id="recibo" style="display: none;">
        <h1>Recibo de Compra</h1>
        <p>Fecha: <span id="fecha"></span></p>
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody id="recibo-items">
                <!-- Los productos del recibo se agregarán aquí -->
            </tbody>
        </table>
        <p>Total: $<span id="recibo-total"></span></p>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItemsContainer = document.querySelector('.cart-items');
            const totalElement = document.getElementById('total');

            let total = 0;

            // Un objeto para agrupar productos por ID
            const productMap = {};

            cart.forEach(item => {
                if (productMap[item.id]) {
                    productMap[item.id].quantity += item.quantity;
                } else {
                    productMap[item.id] = { ...item };
                }
            });

            // Crear elementos HTML para cada producto en el mapa
            Object.values(productMap).forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.classList.add('cart-item');
                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.title}">
                    <div class="cart-item-details">
                        <h4>${item.title}</h4>
                        <p>$${item.price.toFixed(2)} x ${item.quantity}</p>
                        <button class="remove-btn" data-id="${item.id}">Eliminar</button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItem);

                total += item.price * item.quantity;
            });

            totalElement.textContent = total.toFixed(2);

            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const index = cart.findIndex(item => item.id === id);
                    if (index > -1) {
                        cart.splice(index, 1);
                        localStorage.setItem('cart', JSON.stringify(cart));
                        location.reload();
                    }
                });
            });

            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if (cart.length > 0) {
                    const confirmPurchase = confirm('¿Quieres comprar estos productos?');
                    if (confirmPurchase) {
                        alert('Gracias por tu compra.');

                        // Mostrar el botón de descarga del recibo
                        const downloadReceiptButton = document.getElementById('downloadReceipt');
                        downloadReceiptButton.style.display = 'block';

                        // Preparar los datos del recibo
                        const receiptItemsContainer = document.getElementById('recibo-items');
                        const receiptTotalElement = document.getElementById('recibo-total');
                        const receiptDateElement = document.getElementById('fecha');

                        let total = 0;
                        const productGroups = cart.reduce((acc, item) => {
                            if (!acc[item.id]) {
                                acc[item.id] = { ...item };
                            } else {
                                acc[item.id].quantity += item.quantity;
                            }
                            return acc;
                        }, {});

                        // Agregar productos al recibo
                        receiptItemsContainer.innerHTML = ''; // Limpiar el contenedor del recibo
                        Object.values(productGroups).forEach(item => {
                            const receiptItem = document.createElement('tr');
                            receiptItem.innerHTML = `
                                <td>${item.title}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.price.toFixed(2)}</td>
                            `;
                            receiptItemsContainer.appendChild(receiptItem);

                            total += item.price * item.quantity;
                        });

                        receiptTotalElement.textContent = total.toFixed(2);

                        // Establecer la fecha de hoy en el recibo
                        const today = new Date();
                        const dateString = today.toISOString().split('T')[0];
                        receiptDateElement.textContent = dateString;

                        // Limpiar el carrito
                        localStorage.removeItem('cart');
                        location.reload(); // Recarga la página para limpiar el carrito
                    }
                } else {
                    alert('Tu carrito está vacío.');
                }
            });

            // Manejar el clic en el botón para descargar el recibo en PDF
            document.getElementById('downloadReceipt').addEventListener('click', () => {
                const reciboElement = document.getElementById('recibo');
                reciboElement.style.display = 'block'; // Asegúrate de que el recibo sea visible temporalmente

                // Usa html2pdf para convertir el recibo a PDF
                html2pdf()
                    .from(reciboElement)
                    .set({
                        margin: 1,
                        filename: 'recibo.pdf',
                        html2canvas: { scale: 2 },
                        jsPDF: { orientation: 'portrait', unit: 'in', format: 'letter', compressPDF: true }
                    })
                    .save()
                    .then(() => {
                        reciboElement.style.display = 'none'; // Oculta el recibo nuevamente
                    });
            });
        });

        // Agregar productos al carrito (esto va en la página de productos)
        document.querySelectorAll('.agregar-carrito').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');
                const price = parseFloat(button.getAttribute('data-price'));
                const image = button.getAttribute('data-image');

                const cart = JSON.parse(localStorage.getItem('cart')) || [];

                const existingProductIndex = cart.findIndex(item => item.id === id);

                if (existingProductIndex > -1) {
                    cart[existingProductIndex].quantity += 1;
                } else {
                    cart.push({ id, title: name, price, image, quantity: 1 });
                }

                localStorage.setItem('cart', JSON.stringify(cart));
                alert('Producto agregado al carrito');
            });
        });
    </script>
</body>
</html>
